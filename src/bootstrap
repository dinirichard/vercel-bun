#! /bin/sh

# Ensure bootstrap file is in the expected location
if [ ! -f /var/task/bootstrap ]; then
  echo "Bootstrap not in expected location, attempting to copy"
  cp "$0" /var/task/bootstrap
  chmod +x /var/task/bootstrap
fi

# Find Bun binary - use the bundled version from build step
BUN_BINARY="/var/task/bin/bun"

# Verify Bun binary exists, with fallback check
if [ ! -x "$BUN_BINARY" ]; then
  # Fallback to system bun if bundled version not found
  BUN_BINARY="$(which bun 2>/dev/null)"
  if [ ! -x "$BUN_BINARY" ]; then
    echo "Error: Bun binary not found or not executable"
    exit 1
  fi
fi

# Set up writable directories for Bun
export BUN_TMPDIR="/tmp"
export BUN_INSTALL_CACHE_DIR="/tmp/.bun"
export BUN_INSTALL_GLOBAL_DIR="/tmp/.bun"
export BUN_CONFIG_DIR="/tmp/.bun"
export XDG_CACHE_HOME="/tmp/.cache"
export HOME="/tmp"

# Execute Bun runtime
exec "$BUN_BINARY" --cwd $LAMBDA_TASK_ROOT /var/task/runtime/index.ts