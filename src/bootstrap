#! /bin/sh
export BUN_INSTALL_CACHE_DIR=/tmp/bun/cache

# Ensure bootstrap file is in the expected location
if [ ! -f /var/task/bootstrap ]; then
  echo "Bootstrap not in expected location, attempting to copy"
  cp "$0" /var/task/bootstrap
  chmod +x /var/task/bootstrap
fi

# Find Bun binary - check bundled version first
BUN_BINARY=""
for path in "/var/task/bin/bun" "/var/runtime/bin/bun" "/var/lang/bin/bun" "/opt/bun" "$(which bun 2>/dev/null)"; do
  if [ -x "$path" ]; then
    BUN_BINARY="$path"
    break
  fi
done

# Verify Bun binary exists
if [ ! -x "$BUN_BINARY" ]; then
  echo "Error: Bun binary not found or not executable"
  exit 1
fi

echo "Using Bun binary: $BUN_BINARY"

# Log environment information
echo "Environment variables:"
env
echo "Lambda Task Root: $LAMBDA_TASK_ROOT"
echo "Handler: $_HANDLER"
echo "AWS Lambda Runtime API: $AWS_LAMBDA_RUNTIME_API"
echo "Bun Version: $BUN_VERSION"

# Execute Bun runtime
exec "$BUN_BINARY" --cwd $LAMBDA_TASK_ROOT /var/task/runtime.ts